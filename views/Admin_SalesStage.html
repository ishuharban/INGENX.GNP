<!DOCTYPE html>
<html>

<head>
  <title>Sales Stage</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="./Style/dashboard.css">
  <script src="./js/common.js"></script>
</head>
<style>
  #mark {
    margin-top: 100px;
  }

  #pageHeader {
    text-align: center;
    padding: 20px;
    background: black;
    color: white;
    border: 1px solid white;
    font-family: 'Times New Roman', Times, serif;
    width: 100%;
    margin-top: 110px;
  }
</style>

<body>

 <!-- NAVBAR -->

 <nav class="navbar navbar-expand-lg fixed-top">
  <div class="container-fluid">
    <img src="./img/logo-print-hd-transparent.png" class="navbar-brand" alt="INGENX" width="120px" height="70px">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"><i class="fa-sharp fa-solid fa-bars fa-2xl"></i></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" id="home" aria-current="page" href="./home.html"><b>HOME</b></a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown" id="navbarDropdown" role="button" data-bs-toggle="dropdown"
            aria-expanded="false" disabled>
            <b>PARTNER</b>
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            <li><a class="dropdown-item" href="./partnerApproval.html"><b>APPROVAL</b></a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="./partnerStatus.html"><b>STATUS</b></a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="./partnerSummary.html"><b>SUMMARY</b></a></li>
          </ul>
        </li>
        <!-- <li class="nav-item dropdown">
          <a class="nav-link dropdown" id="navbarDropdown" role="button" data-bs-toggle="dropdown"
            aria-expanded="false" disabled>
            <b>DEAL</b>
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            <li><a class="dropdown-item" href="./dealRegister.html"><b>REGISTER</b></a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="./dealApproval.html"><b>APPROVAL</b></a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="./dealStatus.html"><b>STATUS</b></a></li>
            <li>
          </ul>
        </li> -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown" id="navbarDropdown" role="button" data-bs-toggle="dropdown"
            aria-expanded="false" disabled>
            <b>CONFIGURATION</b>
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            <li><a class="dropdown-item" href="./Admin-manage-users.html"><b>Status Management</b></a></li>
            <li>
              <hr class="dropdown-divider">
              <li><a class="dropdown-item" href="./admin_productadd.html"><b>ADD PRODUCT</b></a></li>
            <li>
              <!-- <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="./Admin_SalesStage.html"><b>Sales Stage</b></a></li>
            <li> -->
              <!-- <hr class="dropdown-divider"> -->
            </li> 
            <!-- <li><a class="dropdown-item" href="./dealStatus.html"><b>STATUS</b></a></li> -->
            <li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown" id="navbarDropdown" role="button" data-bs-toggle="dropdown"
            aria-expanded="false" disabled>
            <b>COMMISSION PAYOUT</b>
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            <li><a class="dropdown-item" href="./Admintnc.html"><b>TERMS & AGREEMENTS</b></a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="./invoice.html"><b>INVOICE GENERATE</b></a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="./AdminperformanceGraph.html"><b>PERFORMANCE GRAPH</b></a></li>
          </ul>
        </li>
        <li class="nav-item dropdown profile">
          <a class="nav-link dropdown" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false" disabled>
            <b><i class="fa-solid fa-user fa-xl"></i> PROFILE</b>
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            <form method="get" action="/profile">
              <div id="profile"></div>
            </form>
            <!-- <li>
              <hr class="dropdown-divider">
                              </li>
                              <li><a class="dropdown-item" href="./admin-manage-users.html"><b>Manage Users</b></a></li>
                              <li>
            
            </li> -->
            <li>
              <hr class="dropdown-divider">
                              </li>
                              <li><a class="dropdown-item" href="./Adminpersonaldetails.html"><b>PRESONAL INFO</b></a></li>
                              <li>
            
            </li>
            <li>
              <hr class="dropdown-divider">
                              </li>
                              <li><a class="dropdown-item" href="./AdminSetting.html"><b>CONTACT</b></a></li>
                              <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" onclick="logout()"><b>LOGOUT</b></a></li>
          </ul>
        </li>
      </ul>
      <hr />
      <a href="http://www.ingenxtec.com/"><img src="./img/ingenxlogo.png" alt="INGENX" width="120px" height="40px"
          id="ingenxlogo"></a>
    </div>
  </div>
</nav>
  

  <div class="container-fluid " id="mark">
    <h2 id="pageHeader">Deal Status & Sales Stage</h2>
    <table class="table">
      <thead>
        <!-- <th>ID</th> -->
        <th>Customer Name</th>
        <th>Deal Name</th>
        <th>Sales Stage</th>
        <th> Status</th>
        <th>Stage Update</th>
        <th>Status Update</th>
        <th>Deal Delete</th>
        <th></th>
        <th></th>

        <!-- <th>Email</th>
      <th>Role</th> -->
      </thead>

      <tbody id="user-tables">
        <!-- User data will be inserted here dynamically -->
      </tbody>
    </table>
  </div>


  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <p class="mb-0"><b>&copy; 2023-2024 INGENX TECHNOLOGY | ALL RIGHTS RESERVED</b></p>
        </div>
      </div>
    </div>
  </footer>

  <script>

    // Function to populate the user table
    const urlParams = new URLSearchParams(window.location.search);
    const partnerId = urlParams.get('partnerId');
    console.log(partnerId)

    if (partnerId) {
      async function populateUserTable() {
        try {
          const response = await fetch('/update-sales');
          const users = await response.json();
          const userTable = document.getElementById('user-tables');

          if (users.length === 0) {
            const noDealsMessage = document.createElement('div');
            noDealsMessage.className = 'text-center mt-5 h2';
            noDealsMessage.textContent = 'No deals available for this partner.';
            dealsContainer.appendChild(noDealsMessage);
          }
          else {
            users.forEach((user, i) => {
              if (partnerId == user.user_id) {
              // You can append user data to the userTable or display it as needed
              const row = document.createElement('tr');
              row.innerHTML = `
              <tr>
        
            <td>${user.customername}</td>
          <td>${user.dealname}</td>
          <td>${user.Stage}</td>
          <td>${user.Status}</td>
          
          <td>
            <form action="/update-stage" method="post" class="manage-user-form">
              <input type="hidden" name="id" value="${user._id}" />
              <select name="Stage" id="${user._id}-stage">
                <option value="0%" ${user.Stage === '0%' ? 'selected' : ''
                }>0%</option>
                <option value="10%" ${user.Stage === '10%' ? 'selected' : ''
                }>10%</option>
                <option value="20%" ${user.Stage === '20%' ? 'selected' : ''
                }>20%</option>
                <option value="30%" ${user.Stage === '30%' ? 'selected' : ''
                }>30%</option>
                <option value="40%" ${user.Stage === '40%' ? 'selected' : ''
                }>40%</option>
                <option value="50%" ${user.Stage === '50' ? 'selected' : ''
                }>50%</option>
                <option value="60%" ${user.Stage === '60%' ? 'selected' : ''
                }>60%</option>
                <option value="70%" ${user.Stage === '70%' ? 'selected' : ''
                }>70%</option>
                <option value="80%" ${user.Stage === '80%' ? 'selected' : ''
                }>80%</option>
                <option value="90%" ${user.Stage === '90%' ? 'selected' : ''
                }>90%</option>
                 <option value="100%" ${user.Stage === '100%' ? 'selected' : ''
                }>100%</option>
              </select>
              <input type="submit" value="update">
            </form>
            
          </td>
          <td>
            <form action="/update-Status" method="post" class="manage-user-form">
              <input type="hidden" name="id" value="${user._id}" />

            <select name="Status" id="${user._id}-status">
                <option value="Approved" ${user.Status === 'Approved' ? 'selected' : ''
                }>Approved</option>
                <option value="Rejected" ${user.Status === 'Rejected' ? 'selected' : ''
                }>Rejected</option>
                <option value="Pending" ${user.Status === 'Pending' ? 'selected' : ''
                }>Pending</option>
            
                <textarea name="comment" id="${user._id}-comment" placeholder="Reason for Rejection" style="display: none;"></textarea>
              <input type="submit" value="update">
            </form>
            
          </td>
          <td>
  <button class="delete-deal-button btn btn-danger " data-id="${user._id}">Delete</button>
</td>
        </tr>
           
          `;
          const statusSelect = row.querySelector(`select[name="Status"][id="${user._id}-status"]`);
          const stageSelect = row.querySelector(`select[name="Stage"][id="${user._id}-Stage"]`);
          const commentTextarea = row.querySelector(`textarea[name="comment"][id="${user._id}-comment"]`);

            statusSelect.addEventListener('change', () => {
              if (statusSelect.value === 'Rejected') {
                commentTextarea.style.display = 'block';
              } else {
                commentTextarea.style.display = 'none';
              }
            });
              userTable.appendChild(row);
          }
        })
          ;
          }


        } catch (error) {
          console.error(error);
        }
      }
    
      document.addEventListener('click', async (event) => {
  if (event.target.classList.contains('delete-deal-button')) {
    const id = event.target.getAttribute('data-id');
    if (confirm('Are you sure you want to delete this deal?')) {
      try {
        const response = await fetch(`/DealDeletes/${id}`, {
          method: 'DELETE',
        });
        const data = await response.json();

        if (response.status === 200) {
          alert(data.message);
          event.target.closest('tr').remove();
        } else {
          alert(data.error);
        }
      } catch (error) {
        console.error(error);
        alert('An error occurred while deleting the deal.');
      }
    }
  }
});



    // Call the populateUserTable function when the page loads
    window.onload = populateUserTable;
  }

  </script>
</body>

</html>